apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: ambient-code

# Resources (base + e2e-specific)
resources:
- ../../base
- secrets.yaml
- test-user.yaml
- frontend-ingress.yaml
# backend-ingress removed - all traffic goes through frontend (Next.js proxies to backend)
- operator-config.yaml
- minio-credentials.yaml

# Patches for e2e environment
patches:
- path: namespace-patch.yaml
  target:
    kind: Namespace
    name: ambient-code
- path: pvc-patch.yaml
  target:
    kind: PersistentVolumeClaim
    name: backend-state-pvc
- path: minio-pvc-patch.yaml
  target:
    kind: PersistentVolumeClaim
    name: minio-data
- path: frontend-test-patch.yaml
  target:
    kind: Deployment
    name: frontend
- path: operator-env-patch.yaml
  target:
    kind: Deployment
    name: agentic-operator

# JSON patches to set imagePullPolicy for all deployments
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: backend-api
  path: image-pull-policy-patch.yaml
- target:
    group: apps
    version: v1
    kind: Deployment
    name: frontend
  path: image-pull-policy-patch.yaml
- target:
    group: apps
    version: v1
    kind: Deployment
    name: agentic-operator
  path: image-pull-policy-patch.yaml

# E2E images - use local builds (all components)
# Runner image is controlled by AMBIENT_CODE_RUNNER_IMAGE in operator-env-patch
images:
- name: quay.io/ambient_code/vteam_backend
  newName: vteam_backend
  newTag: latest
- name: quay.io/ambient_code/vteam_frontend
  newName: vteam_frontend
  newTag: latest
- name: quay.io/ambient_code/vteam_operator
  newName: vteam_operator
  newTag: latest

