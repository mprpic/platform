---
title: Agentic Session Lifecycle
---

%%{init: {'theme':'neutral', 'themeVariables': { 'primaryColor': '#f5f5f5', 'primaryTextColor': '#000000', 'primaryBorderColor': '#333333', 'lineColor': '#666666', 'secondaryColor': '#ffffff', 'tertiaryColor': '#f0f0f0', 'fontSize': '14px', 'fontFamily': 'sans-serif'}}}%%

graph TD
    Start(["Session Request<br/>(User submits via Frontend)"])
    Start -->|"1. Create Session"| FrontendSubmit["Frontend<br/>POST /api/projects/:id/sessions<br/>Include: prompt, repos, params"]
    FrontendSubmit -->|"2. API Validation"| BackendReceive["Backend<br/>- Verify user token<br/>- Validate request<br/>- Check namespace RBAC"]
    BackendReceive -->|"3. Create CR"| CreateCR["Create AgenticSession CR<br/>spec:<br/>  prompt: <user task><br/>  repos: [list]<br/>  model: <selected model><br/>  timeout: <configured>"]
    CreateCR -->|"4. CR Stored"| K8sStore["Kubernetes API<br/>AgenticSession CR created<br/>phase: Pending"]
    K8sStore -->|"5. Watch & React"| OperatorWatch["Agentic Operator<br/>(Watching CRs)<br/>Detects: new AgenticSession"]
    OperatorWatch -->|"6. Create Job"| CreateJob["Operator Creates<br/>Kubernetes Job<br/>- Image: claude-code-runner<br/>- Resources: CPU, memory<br/>- Volumes: workspace PVC<br/>- Env: prompt, repos, config"]
    CreateJob -->|"7. Job Scheduled"| JobSchedule["Kubernetes<br/>Job scheduled<br/>phase: Running"]
    JobSchedule -->|"8. Pod Creation"| PodSpawn["Pod Spawned<br/>Container initialized<br/>- Claude Code CLI ready<br/>- MCP servers starting<br/>- Workspace mounted"]
    PodSpawn -->|"9. Initialize Runner"| RunnerInit["Claude Code Runner<br/>Setup Phase<br/>- Load repositories<br/>- Initialize Claude SDK<br/>- MCP server handlers ready<br/>- await user prompt"]
    RunnerInit -->|"10. Execute Task"| RunnerExec["Runner Execution<br/>- Claude Code CLI processes prompt<br/>- Multi-agent reasoning<br/>- MCP tool invocations<br/>- Code analysis & execution<br/>- Streaming results"]
    RunnerExec -->|"11. Stream Output"| StreamResults["Results Streaming<br/>- Pod captures output<br/>- Logs to storage<br/>- Updates CR status<br/>- Emits completion event"]
    StreamResults -->|"12. Update CR Status"| UpdateCR["AgenticSession CR Updated<br/>status:<br/>  phase: Completed<br/>  completionTime: <timestamp><br/>  results: <output><br/>  state: Success/Failed"]
    UpdateCR -->|"13. Detect Completion"| OperatorCleanup["Operator Detects Change<br/>- Monitors Job status<br/>- Verifies Pod completion"]
    OperatorCleanup -->|"14. Cleanup"| CleanupJob["Cleanup Phase<br/>- Delete Job<br/>- Delete Pod<br/>- Preserve logs<br/>- Release resources"]
    CleanupJob -->|"15. Backend Notified"| BackendUpdate["Backend Polls CR<br/>- Detects completion<br/>- Reads results<br/>- Prepares response"]
    BackendUpdate -->|"16. Push to Frontend"| FrontendUpdate["Frontend Updated<br/>- WebSocket notification<br/>or polling response<br/>- Display results<br/>- Show logs<br/>- Enable actions"]
    FrontendUpdate -->|"17. User Sees Results"| End(["Session Complete<br/>(Results available<br/>for review)"])
    RunnerExec -.->|"execution error"| ErrorPath["Error Handler<br/>- Capture error<br/>- Update CR with error msg<br/>- Status: Failed"]
    ErrorPath -.-> UpdateCR
    JobSchedule -.->|"timeout exceeded"| TimeoutPath["Timeout Handler<br/>- Operator monitors elapsed time<br/>- Force pod termination<br/>- Mark as timeout"]
    TimeoutPath -.-> UpdateCR

    classDef default fill:#ffffff,stroke:#333333,stroke-width:2px,color:#000000
    classDef frontend fill:#e8e8e8,stroke:#333333,stroke-width:2px,color:#000000
    classDef backend fill:#f0f0f0,stroke:#333333,stroke-width:2px,color:#000000
    classDef kubernetes fill:#f5f5f5,stroke:#333333,stroke-width:2px,color:#000000
    classDef execution fill:#f9f9f9,stroke:#333333,stroke-width:2px,color:#000000
    classDef error fill:#ffe8e8,stroke:#333333,stroke-width:2px,color:#000000
    classDef startend fill:#e8f5e9,stroke:#333333,stroke-width:2px,color:#000000

    class FrontendSubmit frontend
    class BackendReceive,BackendUpdate backend
    class CreateCR,K8sStore,JobSchedule,UpdateCR kubernetes
    class RunnerInit,RunnerExec,StreamResults execution
    class ErrorPath,TimeoutPath error
    class Start,End startend
