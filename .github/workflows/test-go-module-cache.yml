name: "TEST: Go Module Caching Optimization"

# TEST WORKFLOW - Manual trigger only
# Purpose: Test Go module caching optimization for backend unit tests
# Compare: Run this alongside backend-unit-tests.yml to compare performance
#
# What's being tested:
# - Go module caching with actions/setup-go@v6
# - Build cache for compiled packages
# - Dependency download optimization
#
# Expected improvements:
# - First run: Same as baseline (~2.8 min)
# - Second run (warm cache): ~2.0 min (30% faster)
# - Reduced network I/O for go mod download

on:
  workflow_dispatch:
    inputs:
      test_iteration:
        description: 'Test iteration number (for tracking cache performance)'
        required: false
        type: string
        default: '1'
      test_label:
        description: 'Test label filter (optional, e.g. "integration")'
        required: false
        type: string
        default: ''
      enable_go_cache:
        description: 'Enable Go module caching (turn off for baseline)'
        required: false
        type: boolean
        default: true

concurrency:
  group: test-go-cache-${{ github.event.inputs.test_iteration }}
  cancel-in-progress: true

jobs:
  backend-unit-test-with-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Test Configuration Summary
        run: |
          echo "============================================"
          echo "Go Module Cache Test Configuration"
          echo "============================================"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Go Cache Enabled: ${{ github.event.inputs.enable_go_cache }}"
          echo "Test Label: ${{ github.event.inputs.test_label || 'all tests' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "============================================"
          echo ""
          echo "Expected behavior:"
          echo "- First run: ~2.8 min (cache population)"
          echo "- Second run: ~2.0 min (cache hit, 30% faster)"
          echo "- Go modules cached in ~/.cache/go-build and ~/go/pkg"
          echo "============================================"

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create reports directory
        run: mkdir -p reports

      - name: Record start time
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Set up Go WITH caching (OPTIMIZED)
        if: github.event.inputs.enable_go_cache == 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'components/backend/go.mod'
          # OPTIMIZATION: Enable Go module and build caching
          # This caches:
          # - Downloaded modules in ~/go/pkg/mod
          # - Build cache in ~/.cache/go-build
          # - Significantly reduces dependency download time
          cache: true
          cache-dependency-path: 'components/backend/go.sum'

      - name: Set up Go WITHOUT caching (BASELINE)
        if: github.event.inputs.enable_go_cache != 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'components/backend/go.mod'
          # BASELINE: No caching (current behavior)
          cache: false

      - name: Cache status check
        if: github.event.inputs.enable_go_cache == 'true'
        run: |
          echo "============================================"
          echo "Cache Status"
          echo "============================================"
          echo "Go module cache: ~/go/pkg/mod"
          echo "Go build cache: ~/.cache/go-build"
          echo ""
          if [ -d ~/go/pkg/mod ]; then
            echo "Module cache size: $(du -sh ~/go/pkg/mod | cut -f1)"
          else
            echo "Module cache: Empty (first run)"
          fi
          echo "============================================"

      - name: Configure Input Variables
        working-directory: components/backend
        run: |
          if [ -n "${{ github.event.inputs.test_label }}" ]; then
            echo "TEST_LABEL=${{ github.event.inputs.test_label }}" >> $GITHUB_ENV
          else
            echo "TEST_LABEL=" >> $GITHUB_ENV
          fi

      - name: Run Tests with Ginkgo
        working-directory: components/backend
        run: |
          LABEL_FLAG=""
          if [ -n "$TEST_LABEL" ]; then
            LABEL_FLAG="--label-filter=$TEST_LABEL"
          fi

          go run github.com/onsi/ginkgo/v2/ginkgo \
            -r \
            --randomize-all \
            --randomize-suites \
            --cover \
            --coverprofile=../../reports/coverage.out \
            --race \
            --trace \
            --junit-report=../../reports/junit.xml \
            $LABEL_FLAG \
            ./...

      - name: Record end time and calculate duration
        id: end-time
        if: always()
        run: |
          end_time=$(date +%s)
          start_time=${{ steps.start-time.outputs.time }}
          duration=$((end_time - start_time))
          minutes=$((duration / 60))
          seconds=$((duration % 60))

          echo "duration_seconds=$duration" >> $GITHUB_OUTPUT
          echo "duration_formatted=${minutes}m ${seconds}s" >> $GITHUB_OUTPUT

      - name: Install Junit2Html plugin and generate report
        if: always()
        working-directory: components/backend
        run: |
          go install github.com/alexec/junit2html@latest
          ~/go/bin/junit2html < ../../reports/junit.xml > ../../reports/test-report.html

      - name: Configure report name
        if: always()
        id: report-name
        run: |
          REPORT_NAME="backend-test-report-cache${{ github.event.inputs.enable_go_cache }}-iter${{ github.event.inputs.test_iteration }}"
          echo "name=$REPORT_NAME" >> $GITHUB_OUTPUT

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.report-name.outputs.name }}
          path: reports/test-report.html
          retention-days: 7

      - name: Performance Summary
        if: always()
        run: |
          echo "============================================"
          echo "Test Performance Summary"
          echo "============================================"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Go Cache Enabled: ${{ github.event.inputs.enable_go_cache }}"
          echo ""
          echo "Test Duration: ${{ steps.end-time.outputs.duration_formatted }}"
          echo "Total Seconds: ${{ steps.end-time.outputs.duration_seconds }}"
          echo ""
          echo "============================================"
          echo "Comparison Guidance:"
          echo "============================================"
          echo "1. Run this workflow multiple times with cache enabled"
          echo "2. First run: Expect ~2.8 min (cache population)"
          echo "3. Second run: Expect ~2.0 min (cache hit)"
          echo "4. Compare to baseline (enable_go_cache=false)"
          echo "5. Check cache size in Actions cache dashboard"
          echo ""
          echo "Cache savings come from:"
          echo "- Skip 'go mod download' (modules cached)"
          echo "- Skip compilation of unchanged packages (build cache)"
          echo "- Faster test execution overall"
          echo "============================================"

      - name: Cache analysis
        if: always() && github.event.inputs.enable_go_cache == 'true'
        run: |
          echo "============================================"
          echo "Cache Analysis"
          echo "============================================"
          if [ -d ~/go/pkg/mod ]; then
            echo "Go module cache size: $(du -sh ~/go/pkg/mod | cut -f1)"
            echo "Number of cached modules: $(find ~/go/pkg/mod -type d -depth 2 | wc -l)"
          fi

          if [ -d ~/.cache/go-build ]; then
            echo "Go build cache size: $(du -sh ~/.cache/go-build | cut -f1)"
          fi

          echo ""
          echo "To check GitHub Actions cache:"
          echo "  gh api repos/${{ github.repository }}/actions/caches --jq '.actions_caches[] | select(.key | contains(\"go\"))'"
          echo "============================================"

      - name: Export test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/go-cache-test-iter${{ github.event.inputs.test_iteration }}.json << EOF
          {
            "test_iteration": "${{ github.event.inputs.test_iteration }}",
            "go_cache_enabled": ${{ github.event.inputs.enable_go_cache }},
            "test_label": "${{ github.event.inputs.test_label }}",
            "duration_seconds": ${{ steps.end-time.outputs.duration_seconds }},
            "duration_formatted": "${{ steps.end-time.outputs.duration_formatted }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cat test-results/go-cache-test-iter${{ github.event.inputs.test_iteration }}.json

      - name: Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: go-cache-test-results-iter${{ github.event.inputs.test_iteration }}
          path: test-results/
          retention-days: 30

      - name: Publish Test Summary With HTML Report
        uses: kubeflow/pipelines/.github/actions/junit-summary@master
        if: always()
        with:
          junit_path: reports/junit.xml

      - name: Publish Test Summary
        if: always()
        run: |
          if [ -f reports/junit.xml ]; then
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Duration: ${{ steps.end-time.outputs.duration_formatted }}" >> $GITHUB_STEP_SUMMARY
            echo "Cache Enabled: ${{ github.event.inputs.enable_go_cache }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Mark Workflow failure if test step failed
        if: failure()
        run: |
          echo "::error::Tests failed or timed out"
          exit 1
