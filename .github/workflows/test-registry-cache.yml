name: "TEST: Registry Cache Optimization"

# TEST WORKFLOW - Manual trigger only
# Purpose: Test registry cache optimization for Docker builds
# Compare: Run this alongside components-build-deploy.yml to compare performance
#
# What's being tested:
# - Registry cache (type=registry) for persistent caching
# - Component-specific cache scopes for better hit rates
# - Fallback to GHA cache for redundancy
#
# Expected improvements:
# - First run: Same as baseline (~30-38 min)
# - Second run (warm cache): 5-10 min (75-85% faster)
# - Cache persistence: Won't expire like GHA cache (7 days)

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build (frontend, backend, operator, claude-runner, state-sync)'
        required: true
        type: choice
        options:
          - frontend
          - backend
          - operator
          - claude-runner
          - state-sync
      test_iteration:
        description: 'Test iteration number (for tracking cache performance)'
        required: false
        type: string
        default: '1'
      enable_registry_cache:
        description: 'Enable registry cache (turn off to test GHA-only)'
        required: false
        type: boolean
        default: true

concurrency:
  group: test-registry-cache-${{ github.event.inputs.component }}
  cancel-in-progress: true

jobs:
  build-with-registry-cache:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Test Configuration Summary
        run: |
          echo "============================================"
          echo "Registry Cache Test Configuration"
          echo "============================================"
          echo "Component: ${{ github.event.inputs.component }}"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Registry Cache: ${{ github.event.inputs.enable_registry_cache }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "============================================"
          echo ""
          echo "Expected behavior:"
          echo "- First run: ~30-38 min (cache population)"
          echo "- Second run: ~5-10 min (cache hit)"
          echo "- Registry cache persists across runs"
          echo "- GHA cache provides fallback"
          echo "============================================"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.sha }}

      - name: Set component configuration
        id: config
        run: |
          case "${{ github.event.inputs.component }}" in
            frontend)
              echo "context=./components/frontend" >> $GITHUB_OUTPUT
              echo "dockerfile=./components/frontend/Dockerfile" >> $GITHUB_OUTPUT
              echo "image=quay.io/ambient_code/vteam_frontend" >> $GITHUB_OUTPUT
              ;;
            backend)
              echo "context=./components/backend" >> $GITHUB_OUTPUT
              echo "dockerfile=./components/backend/Dockerfile" >> $GITHUB_OUTPUT
              echo "image=quay.io/ambient_code/vteam_backend" >> $GITHUB_OUTPUT
              ;;
            operator)
              echo "context=./components/operator" >> $GITHUB_OUTPUT
              echo "dockerfile=./components/operator/Dockerfile" >> $GITHUB_OUTPUT
              echo "image=quay.io/ambient_code/vteam_operator" >> $GITHUB_OUTPUT
              ;;
            claude-runner)
              echo "context=./components/runners" >> $GITHUB_OUTPUT
              echo "dockerfile=./components/runners/claude-code-runner/Dockerfile" >> $GITHUB_OUTPUT
              echo "image=quay.io/ambient_code/vteam_claude_runner" >> $GITHUB_OUTPUT
              ;;
            state-sync)
              echo "context=./components/runners/state-sync" >> $GITHUB_OUTPUT
              echo "dockerfile=./components/runners/state-sync/Dockerfile" >> $GITHUB_OUTPUT
              echo "image=quay.io/ambient_code/vteam_state_sync" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Log in to Red Hat Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.redhat.io
          username: ${{ secrets.REDHAT_USERNAME }}
          password: ${{ secrets.REDHAT_PASSWORD }}

      - name: Record start time
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build with OPTIMIZED registry cache
        if: github.event.inputs.enable_registry_cache == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ steps.config.outputs.context }}
          file: ${{ steps.config.outputs.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: false
          tags: |
            ${{ steps.config.outputs.image }}:test-registry-cache-${{ github.event.inputs.test_iteration }}
            ${{ steps.config.outputs.image }}:test-${{ github.sha }}
          # OPTIMIZATION: Multi-tier caching strategy
          # 1. Registry cache (primary) - persistent, fast, unlimited size
          # 2. GHA cache (fallback) - helps with cross-PR caching
          cache-from: |
            type=registry,ref=${{ steps.config.outputs.image }}:buildcache
            type=gha,scope=${{ github.event.inputs.component }}-${{ github.base_ref || github.ref_name }}
            type=gha,scope=${{ github.event.inputs.component }}-main
          cache-to: |
            type=registry,ref=${{ steps.config.outputs.image }}:buildcache,mode=max
            type=gha,mode=max,scope=${{ github.event.inputs.component }}-${{ github.ref_name }}

      - name: Build with BASELINE GHA-only cache (for comparison)
        if: github.event.inputs.enable_registry_cache != 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ steps.config.outputs.context }}
          file: ${{ steps.config.outputs.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: false
          tags: |
            ${{ steps.config.outputs.image }}:test-baseline-${{ github.event.inputs.test_iteration }}
            ${{ steps.config.outputs.image }}:test-${{ github.sha }}
          # BASELINE: Current caching strategy (GHA only)
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Record end time and calculate duration
        id: end-time
        run: |
          end_time=$(date +%s)
          start_time=${{ steps.start-time.outputs.time }}
          duration=$((end_time - start_time))
          minutes=$((duration / 60))
          seconds=$((duration % 60))

          echo "duration_seconds=$duration" >> $GITHUB_OUTPUT
          echo "duration_formatted=${minutes}m ${seconds}s" >> $GITHUB_OUTPUT

      - name: Performance Summary
        run: |
          echo "============================================"
          echo "Build Performance Summary"
          echo "============================================"
          echo "Component: ${{ github.event.inputs.component }}"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Registry Cache Enabled: ${{ github.event.inputs.enable_registry_cache }}"
          echo ""
          echo "Build Duration: ${{ steps.end-time.outputs.duration_formatted }}"
          echo "Total Seconds: ${{ steps.end-time.outputs.duration_seconds }}"
          echo ""
          echo "============================================"
          echo "Comparison Guidance:"
          echo "============================================"
          echo "1. Run this workflow multiple times with registry cache enabled"
          echo "2. First run: Expect ~30-38 min (cache population)"
          echo "3. Second run: Expect ~5-10 min (cache hit)"
          echo "4. Compare to baseline workflow performance"
          echo "5. Check cache size in Quay.io registry"
          echo ""
          echo "To test baseline (GHA-only):"
          echo "- Set 'enable_registry_cache' to false"
          echo "- Compare performance with registry cache enabled"
          echo "============================================"

      - name: Cache Analysis
        run: |
          echo "============================================"
          echo "Cache Analysis"
          echo "============================================"
          echo "Registry Cache Tag: ${{ steps.config.outputs.image }}:buildcache"
          echo "GHA Cache Scope: ${{ github.event.inputs.component }}-${{ github.ref_name }}"
          echo ""
          echo "To check registry cache:"
          echo "  docker pull ${{ steps.config.outputs.image }}:buildcache"
          echo ""
          echo "To check GHA cache size:"
          echo "  gh api repos/${{ github.repository }}/actions/caches"
          echo "============================================"

      - name: Export test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/registry-cache-test-${{ github.event.inputs.component }}-iter${{ github.event.inputs.test_iteration }}.json << EOF
          {
            "component": "${{ github.event.inputs.component }}",
            "test_iteration": "${{ github.event.inputs.test_iteration }}",
            "registry_cache_enabled": ${{ github.event.inputs.enable_registry_cache }},
            "duration_seconds": ${{ steps.end-time.outputs.duration_seconds }},
            "duration_formatted": "${{ steps.end-time.outputs.duration_formatted }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cat test-results/registry-cache-test-${{ github.event.inputs.component }}-iter${{ github.event.inputs.test_iteration }}.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: registry-cache-test-${{ github.event.inputs.component }}-iter${{ github.event.inputs.test_iteration }}
          path: test-results/
          retention-days: 30
