name: "TEST: E2E Docker Layer Caching"

# TEST WORKFLOW - Manual trigger only
# Purpose: Test Docker layer caching optimization for E2E tests
# Compare: Run this alongside e2e.yml to compare performance
#
# What's being tested:
# - Docker buildx layer caching with GHA cache backend
# - Component-specific cache scopes
# - Conditional builds based on changes
#
# Expected improvements:
# - First run: Same as baseline (~7.16 min)
# - Second run (warm cache): ~5-6 min (25% faster)
# - Faster Docker builds for unchanged components

on:
  workflow_dispatch:
    inputs:
      test_iteration:
        description: 'Test iteration number (for tracking cache performance)'
        required: false
        type: string
        default: '1'
      enable_docker_cache:
        description: 'Enable Docker layer caching (turn off for baseline)'
        required: false
        type: boolean
        default: true
      force_build_all:
        description: 'Force build all components (ignore change detection)'
        required: false
        type: boolean
        default: false

concurrency:
  group: test-e2e-cache-${{ github.event.inputs.test_iteration }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      operator: ${{ steps.filter.outputs.operator }}
      claude-runner: ${{ steps.filter.outputs.claude-runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for component changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'components/frontend/**'
            backend:
              - 'components/backend/**'
            operator:
              - 'components/operator/**'
            claude-runner:
              - 'components/runners/**'

  e2e-with-docker-cache:
    name: E2E Tests with Docker Cache
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 25

    steps:
      - name: Test Configuration Summary
        run: |
          echo "============================================"
          echo "E2E Docker Cache Test Configuration"
          echo "============================================"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Docker Cache Enabled: ${{ github.event.inputs.enable_docker_cache }}"
          echo "Force Build All: ${{ github.event.inputs.force_build_all }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "============================================"
          echo ""
          echo "Component changes detected:"
          echo "  Frontend: ${{ needs.detect-changes.outputs.frontend }}"
          echo "  Backend: ${{ needs.detect-changes.outputs.backend }}"
          echo "  Operator: ${{ needs.detect-changes.outputs.operator }}"
          echo "  Claude Runner: ${{ needs.detect-changes.outputs.claude-runner }}"
          echo ""
          echo "Expected behavior:"
          echo "- First run: ~7-8 min (cache population)"
          echo "- Second run: ~5-6 min (cache hit, 25% faster)"
          echo "- Docker layers cached in GHA cache"
          echo "============================================"

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cleanup Diskspace
        id: cleanup
        uses: kubeflow/pipelines/.github/actions/github-disk-cleanup@master
        if: (!cancelled())

      - name: Validate AGENTS.md symlink
        run: |
          echo "Validating AGENTS.md → CLAUDE.md symlink..."
          [ -L AGENTS.md ] || (echo "❌ AGENTS.md is not a symlink" && exit 1)
          [ "$(readlink AGENTS.md)" = "CLAUDE.md" ] || (echo "❌ AGENTS.md points to wrong target" && exit 1)
          [ -f CLAUDE.md ] || (echo "❌ CLAUDE.md does not exist" && exit 1)
          diff -q AGENTS.md CLAUDE.md > /dev/null || (echo "❌ AGENTS.md content differs from CLAUDE.md" && exit 1)
          echo "✅ AGENTS.md symlink is valid"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: e2e/package-lock.json

      - name: Install Cypress dependencies
        working-directory: e2e
        run: npm ci

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Record start time
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build component images WITH Docker cache (OPTIMIZED)
        if: github.event.inputs.enable_docker_cache == 'true'
        run: |
          echo "======================================"
          echo "Building images with OPTIMIZED caching..."
          echo "======================================"

          # Determine which components to build
          BUILD_FRONTEND="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.frontend == 'true' }}"
          BUILD_BACKEND="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.backend == 'true' }}"
          BUILD_OPERATOR="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.operator == 'true' }}"
          BUILD_RUNNER="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.claude-runner == 'true' }}"

          # Build frontend with cache
          if [ "$BUILD_FRONTEND" = "true" ]; then
            echo "Building frontend (changed or forced)..."
            docker buildx build \
              --load \
              -t quay.io/ambient_code/vteam_frontend:e2e-test \
              -f components/frontend/Dockerfile \
              --cache-from type=gha,scope=e2e-frontend \
              --cache-to type=gha,mode=max,scope=e2e-frontend \
              components/frontend
          else
            echo "Frontend unchanged, pulling latest..."
            docker pull quay.io/ambient_code/vteam_frontend:latest
            docker tag quay.io/ambient_code/vteam_frontend:latest quay.io/ambient_code/vteam_frontend:e2e-test
          fi

          # Build backend with cache
          if [ "$BUILD_BACKEND" = "true" ]; then
            echo "Building backend (changed or forced)..."
            docker buildx build \
              --load \
              -t quay.io/ambient_code/vteam_backend:e2e-test \
              -f components/backend/Dockerfile \
              --cache-from type=gha,scope=e2e-backend \
              --cache-to type=gha,mode=max,scope=e2e-backend \
              components/backend
          else
            echo "Backend unchanged, pulling latest..."
            docker pull quay.io/ambient_code/vteam_backend:latest
            docker tag quay.io/ambient_code/vteam_backend:latest quay.io/ambient_code/vteam_backend:e2e-test
          fi

          # Build operator with cache
          if [ "$BUILD_OPERATOR" = "true" ]; then
            echo "Building operator (changed or forced)..."
            docker buildx build \
              --load \
              -t quay.io/ambient_code/vteam_operator:e2e-test \
              -f components/operator/Dockerfile \
              --cache-from type=gha,scope=e2e-operator \
              --cache-to type=gha,mode=max,scope=e2e-operator \
              components/operator
          else
            echo "Operator unchanged, pulling latest..."
            docker pull quay.io/ambient_code/vteam_operator:latest
            docker tag quay.io/ambient_code/vteam_operator:latest quay.io/ambient_code/vteam_operator:e2e-test
          fi

          # Build claude-runner with cache
          if [ "$BUILD_RUNNER" = "true" ]; then
            echo "Building claude-code-runner (changed or forced)..."
            docker buildx build \
              --load \
              -t quay.io/ambient_code/vteam_claude_runner:e2e-test \
              -f components/runners/claude-code-runner/Dockerfile \
              --cache-from type=gha,scope=e2e-claude-runner \
              --cache-to type=gha,mode=max,scope=e2e-claude-runner \
              components/runners
          else
            echo "Claude-runner unchanged, pulling latest..."
            docker pull quay.io/ambient_code/vteam_claude_runner:latest
            docker tag quay.io/ambient_code/vteam_claude_runner:latest quay.io/ambient_code/vteam_claude_runner:e2e-test
          fi

          echo ""
          echo "✅ All images ready"
          docker images | grep e2e-test

      - name: Build component images WITHOUT cache (BASELINE)
        if: github.event.inputs.enable_docker_cache != 'true'
        run: |
          echo "======================================"
          echo "Building images WITHOUT cache (baseline)..."
          echo "======================================"

          # Same logic as above but without cache flags
          BUILD_FRONTEND="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.frontend == 'true' }}"
          BUILD_BACKEND="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.backend == 'true' }}"
          BUILD_OPERATOR="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.operator == 'true' }}"
          BUILD_RUNNER="${{ github.event.inputs.force_build_all == 'true' || needs.detect-changes.outputs.claude-runner == 'true' }}"

          if [ "$BUILD_FRONTEND" = "true" ]; then
            echo "Building frontend..."
            docker build -t quay.io/ambient_code/vteam_frontend:e2e-test \
              -f components/frontend/Dockerfile components/frontend
          else
            docker pull quay.io/ambient_code/vteam_frontend:latest
            docker tag quay.io/ambient_code/vteam_frontend:latest quay.io/ambient_code/vteam_frontend:e2e-test
          fi

          if [ "$BUILD_BACKEND" = "true" ]; then
            echo "Building backend..."
            docker build -t quay.io/ambient_code/vteam_backend:e2e-test \
              -f components/backend/Dockerfile components/backend
          else
            docker pull quay.io/ambient_code/vteam_backend:latest
            docker tag quay.io/ambient_code/vteam_backend:latest quay.io/ambient_code/vteam_backend:e2e-test
          fi

          if [ "$BUILD_OPERATOR" = "true" ]; then
            echo "Building operator..."
            docker build -t quay.io/ambient_code/vteam_operator:e2e-test \
              -f components/operator/Dockerfile components/operator
          else
            docker pull quay.io/ambient_code/vteam_operator:latest
            docker tag quay.io/ambient_code/vteam_operator:latest quay.io/ambient_code/vteam_operator:e2e-test
          fi

          if [ "$BUILD_RUNNER" = "true" ]; then
            echo "Building claude-runner..."
            docker build -t quay.io/ambient_code/vteam_claude_runner:e2e-test \
              -f components/runners/claude-code-runner/Dockerfile components/runners
          else
            docker pull quay.io/ambient_code/vteam_claude_runner:latest
            docker tag quay.io/ambient_code/vteam_claude_runner:latest quay.io/ambient_code/vteam_claude_runner:e2e-test
          fi

          echo "✅ All images ready"
          docker images | grep e2e-test

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Setup kind cluster
        working-directory: e2e
        run: |
          chmod +x scripts/*.sh
          ./scripts/setup-kind.sh

      - name: Load images into kind cluster
        run: |
          echo "======================================"
          echo "Loading images into kind cluster..."
          echo "======================================"
          kind load docker-image quay.io/ambient_code/vteam_frontend:e2e-test --name ambient-local
          kind load docker-image quay.io/ambient_code/vteam_backend:e2e-test --name ambient-local
          kind load docker-image quay.io/ambient_code/vteam_operator:e2e-test --name ambient-local
          kind load docker-image quay.io/ambient_code/vteam_claude_runner:e2e-test --name ambient-local
          echo "✅ All images loaded into kind cluster"

      - name: Update kustomization to use e2e-test images
        run: |
          sed -i 's/newTag: latest/newTag: e2e-test/g' components/manifests/overlays/e2e/kustomization.yaml
          echo "Updated kustomization.yaml to use e2e-test tag"

      - name: Deploy vTeam
        working-directory: e2e
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: ./scripts/deploy.sh

      - name: Verify deployment
        run: |
          echo "Checking pods..."
          kubectl get pods -n ambient-code
          echo ""
          echo "Checking services..."
          kubectl get svc -n ambient-code

      - name: Run Cypress tests
        working-directory: e2e
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: ./scripts/run-tests.sh

      - name: Record end time and calculate duration
        id: end-time
        if: always()
        run: |
          end_time=$(date +%s)
          start_time=${{ steps.start-time.outputs.time }}
          duration=$((end_time - start_time))
          minutes=$((duration / 60))
          seconds=$((duration % 60))

          echo "duration_seconds=$duration" >> $GITHUB_OUTPUT
          echo "duration_formatted=${minutes}m ${seconds}s" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: cypress-screenshots-iter${{ github.event.inputs.test_iteration }}
          path: e2e/cypress/screenshots
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: cypress-videos-iter${{ github.event.inputs.test_iteration }}
          path: e2e/cypress/videos
          if-no-files-found: ignore
          retention-days: 7

      - name: Debug logs on failure
        if: failure()
        run: |
          echo "=== Frontend logs ==="
          kubectl logs -n ambient-code -l app=frontend --tail=100 || true
          echo ""
          echo "=== Backend logs ==="
          kubectl logs -n ambient-code -l app=backend-api --tail=100 || true
          echo ""
          echo "=== Operator logs ==="
          kubectl logs -n ambient-code -l app=agentic-operator --tail=100 || true

      - name: Performance Summary
        if: always()
        run: |
          echo "============================================"
          echo "E2E Test Performance Summary"
          echo "============================================"
          echo "Test Iteration: ${{ github.event.inputs.test_iteration }}"
          echo "Docker Cache Enabled: ${{ github.event.inputs.enable_docker_cache }}"
          echo ""
          echo "Total Duration: ${{ steps.end-time.outputs.duration_formatted }}"
          echo "Total Seconds: ${{ steps.end-time.outputs.duration_seconds }}"
          echo ""
          echo "============================================"
          echo "Comparison Guidance:"
          echo "============================================"
          echo "1. Run this workflow multiple times with cache enabled"
          echo "2. First run: Expect ~7-8 min (cache population)"
          echo "3. Second run: Expect ~5-6 min (cache hit)"
          echo "4. Compare to baseline (enable_docker_cache=false)"
          echo "5. Check cache size in Actions cache dashboard"
          echo ""
          echo "Breakdown (approximate):"
          echo "- Build images: Major time saver with cache"
          echo "- Kind setup: ~1-2 min (unchanged)"
          echo "- Deploy: ~1 min (unchanged)"
          echo "- Tests: ~2-3 min (unchanged)"
          echo "============================================"

      - name: Cache analysis
        if: always() && github.event.inputs.enable_docker_cache == 'true'
        run: |
          echo "============================================"
          echo "Docker Cache Analysis"
          echo "============================================"
          echo "Cache scopes used:"
          echo "  - e2e-frontend"
          echo "  - e2e-backend"
          echo "  - e2e-operator"
          echo "  - e2e-claude-runner"
          echo ""
          echo "To check cache sizes:"
          echo "  gh api repos/${{ github.repository }}/actions/caches --jq '.actions_caches[] | select(.key | contains(\"e2e\"))'"
          echo "============================================"

      - name: Export test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/e2e-cache-test-iter${{ github.event.inputs.test_iteration }}.json << EOF
          {
            "test_iteration": "${{ github.event.inputs.test_iteration }}",
            "docker_cache_enabled": ${{ github.event.inputs.enable_docker_cache }},
            "force_build_all": ${{ github.event.inputs.force_build_all }},
            "duration_seconds": ${{ steps.end-time.outputs.duration_seconds }},
            "duration_formatted": "${{ steps.end-time.outputs.duration_formatted }}",
            "components_changed": {
              "frontend": "${{ needs.detect-changes.outputs.frontend }}",
              "backend": "${{ needs.detect-changes.outputs.backend }}",
              "operator": "${{ needs.detect-changes.outputs.operator }}",
              "claude_runner": "${{ needs.detect-changes.outputs.claude-runner }}"
            },
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cat test-results/e2e-cache-test-iter${{ github.event.inputs.test_iteration }}.json

      - name: Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-cache-test-results-iter${{ github.event.inputs.test_iteration }}
          path: test-results/
          retention-days: 30

      - name: Cleanup
        if: always()
        working-directory: e2e
        run: |
          CLEANUP_ARTIFACTS=true ./scripts/cleanup.sh || true
