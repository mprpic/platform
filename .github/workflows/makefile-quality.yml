name: Makefile Quality Check

# ============================================================================
# WORKFLOW MAINTENANCE INSTRUCTIONS FOR FUTURE AGENTS/DEVELOPERS
# ============================================================================
#
# This workflow validates the Makefile for quality, consistency, and best practices.
# It contains checks that reference specific Makefile content. When updating the
# Makefile, you MUST keep this workflow in sync.
#
# WHEN TO UPDATE THIS WORKFLOW:
#
# 1. ADDING/REMOVING CORE TARGETS
#    - Location: "Verify all required targets exist" step (lines ~45-73)
#    - Action: Update the `required_targets` array to match critical Makefile targets
#    - Verify: Run `grep "^target-name:" Makefile` to confirm target exists
#    - Example: If you add a new core target like "test-integration", add it to the array
#
# 2. CHANGING HELP OUTPUT FORMAT
#    - Location: "Test help target output" step (lines ~129-150)
#    - Action: Update the grep patterns to match new section headers
#    - Verify: Run `make help | grep "Section Name:"` to see actual output
#    - Example: If you rename "Quick Start:" to "Getting Started:", update line ~135
#
# 3. ADJUSTING QUALITY THRESHOLDS
#    - Location: "Verify target documentation" step (lines ~152-172)
#    - Action: Update percentage threshold (currently 50% minimum)
#    - Rationale: Threshold represents minimum acceptable documentation coverage
#    - Example: If requiring stricter docs, change line ~167 to higher percentage
#
# 4. CHANGING VARIABLE NAMES
#    - Location: "Check for hardcoded values" step (lines ~109-127)
#    - Action: Update search patterns if NAMESPACE or CONTAINER_ENGINE variable names change
#    - Verify: Ensure grep patterns exclude the new variable declaration line
#    - Example: If NAMESPACE becomes KUBE_NAMESPACE, update all references
#
# 5. ADDING NEW SCRIPT DIRECTORIES
#    - Location: "on.pull_request.paths" section (lines ~5-8)
#    - Action: Add new script paths that should trigger this workflow
#    - Example: If adding scripts/validation/*.sh, add to paths filter
#
# HOW TO VERIFY CHANGES:
#
# 1. Test locally before committing:
#    - Run: `make validate-makefile` (should pass)
#    - Run: `make lint-makefile` (should pass)
#    - Verify: All referenced targets exist in Makefile
#    - Verify: All help output strings match actual output
#
# 2. After updating required_targets array:
#    - Run: `for target in target1 target2; do grep -q "^${target}:" Makefile && echo "âœ“ $target" || echo "âœ— MISSING: $target"; done`
#
# 3. After updating help output checks:
#    - Run: `make help > /tmp/test.txt && grep -E "Section Name:" /tmp/test.txt`
#
# IMPLEMENTATION PRINCIPLES:
#
# - NO MAGIC STRINGS: All strings checked must exist in actual Makefile output
# - NO HALLUCINATIONS: All file paths must exist in repository
# - DOCUMENTED THRESHOLDS: All numeric thresholds must have rationale comments
# - FAIL-FAST: Hard requirements (missing targets) fail the workflow
# - WARN-SOFT: Quality suggestions (documentation %) show warnings only
#
# ============================================================================

on:
  pull_request:
    paths:
      - 'Makefile'
      - '.github/workflows/makefile-quality.yml'
  push:
    branches:
      - main
    paths:
      - 'Makefile'

jobs:
  validate-makefile:
    name: Validate Makefile
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        shellcheck --version
    
    - name: Run Makefile self-validation
      run: |
        echo "ğŸ” Running Makefile self-validation (all quality checks)..."
        make self-validate
        
    - name: Summary
      if: success()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  Makefile Quality Check Summary"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… All quality checks passed!"
        echo ""
        echo "The Makefile meets quality standards and is ready for use."

